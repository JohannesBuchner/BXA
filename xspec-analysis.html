
<!DOCTYPE html>

<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Xspec with BXA &#8212; BXA (Bayesian X-ray Analysis) 4.0.7 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css" />
    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/_sphinx_javascript_frameworks_compat.js"></script>
    <script src="_static/doctools.js"></script>
    <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Contributing" href="contributing.html" />
    <link rel="prev" title="Sherpa with BXA" href="sherpa-analysis.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  
  
    <link rel="canonical" href="https://johannesbuchner.github.io/BXA/xspec-analysis.html"/>
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="xspec-with-bxa">
<h1>Xspec with BXA<a class="headerlink" href="#xspec-with-bxa" title="Permalink to this heading">¶</a></h1>
<p>This documentation shows how to use BXA with <a class="reference external" href="https://heasarc.gsfc.nasa.gov/xanadu/xspec/python/html/">PyXSpec</a>.</p>
<p>Begin by importing bxa in a python session with heasoft loaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bxa.xspec</span> <span class="k">as</span> <span class="nn">bxa</span>
<span class="kn">from</span> <span class="nn">xspec</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>
</div>
<p>Load your data, define your background model and source model as usual
with <a class="reference external" href="https://heasarc.gsfc.nasa.gov/xanadu/xspec/python/html/">PyXSpec</a>.</p>
<section id="defining-priors">
<span id="xspec-priors"></span><h2>Defining priors<a class="headerlink" href="#defining-priors" title="Permalink to this heading">¶</a></h2>
<p>Define your background model and source model as usual in xspec.
Then define the priors over the free parameters, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># set model and parameters ranges</span>
<span class="c1">#                         val, delta, min, bottom, top, max</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="s2">&quot;pow&quot;</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">norm</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;,,1e-10,1e-10,1e1,1e1&quot;</span> <span class="c1"># 10^-10 .. 10</span>
<span class="n">m</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">PhoIndex</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="s2">&quot;,,1,1,3,3&quot;</span>         <span class="c1">#     1 .. 3</span>

<span class="c1"># define prior</span>
<span class="n">transformations</span> <span class="o">=</span> <span class="p">[</span>
	<span class="c1"># uniform prior for Photon Index (see other example for </span>
	<span class="c1"># something more advanced)</span>
	<span class="n">bxa</span><span class="o">.</span><span class="n">create_uniform_prior_for</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">PhoIndex</span><span class="p">),</span>
	<span class="c1"># jeffreys prior for scale variable</span>
	<span class="n">bxa</span><span class="o">.</span><span class="n">create_jeffreys_prior_for</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">powerlaw</span><span class="o">.</span><span class="n">norm</span><span class="p">),</span>
	<span class="c1"># and possibly many more parameters here</span>
<span class="p">]</span>
</pre></div>
</div>
<p>The above is taken from
<a class="reference external" href="https://github.com/JohannesBuchner/BXA/blob/master/examples/xspec/example_simplest.py">examples/xspec/example_simplest.py</a>.</p>
<p>Make sure you set the parameter minimum and maximum values to appropriate (a priori reasonable) values.
The limits are used to define the uniform and loguniform priors.</p>
<p>You can freeze the parameters you do not want to investigate, but BXA only modifies the parameters specified.</p>
<p>You can also define your own prior functions, which transform
unit variables unto the values needed for each parameter.
See the <a class="reference external" href="https://johannesbuchner.github.io/UltraNest/priors.html">UltraNest documentation on priors</a>
for more details about this concept.
The script <a class="reference external" href="https://github.com/JohannesBuchner/BXA/blob/master/examples/xspec/example_advanced_priors.py">examples/xspec/example_advanced_priors.py</a>
gives an example of such a custom prior function (<cite>my_custom_prior</cite>).</p>
<p>API information:</p>
<dl class="py function">
<dt class="sig sig-object py" id="bxa.xspec.create_uniform_prior_for">
<span class="sig-prename descclassname"><span class="pre">bxa.xspec.</span></span><span class="sig-name descname"><span class="pre">create_uniform_prior_for</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">par</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/priors.html#create_uniform_prior_for"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.create_uniform_prior_for" title="Permalink to this definition">¶</a></dt>
<dd><p>Use for location variables (position)
The uniform prior gives equal weight in non-logarithmic scale.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="bxa.xspec.create_loguniform_prior_for">
<span class="sig-prename descclassname"><span class="pre">bxa.xspec.</span></span><span class="sig-name descname"><span class="pre">create_loguniform_prior_for</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">par</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/priors.html#create_loguniform_prior_for"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.create_loguniform_prior_for" title="Permalink to this definition">¶</a></dt>
<dd><p>Use for scale variables (order of magnitude)
The Jeffreys prior gives equal weight to each order of magnitude between the
minimum and maximum value. Flat in logarithmic scale</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="bxa.xspec.create_gaussian_prior_for">
<span class="sig-prename descclassname"><span class="pre">bxa.xspec.</span></span><span class="sig-name descname"><span class="pre">create_gaussian_prior_for</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">par</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">mean</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">std</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/priors.html#create_gaussian_prior_for"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.create_gaussian_prior_for" title="Permalink to this definition">¶</a></dt>
<dd><p>Use for informed variables.
The Gaussian prior weights by a Gaussian in the parameter.</p>
</dd></dl>

<dl class="py function">
<dt class="sig sig-object py" id="bxa.xspec.create_custom_prior_for">
<span class="sig-prename descclassname"><span class="pre">bxa.xspec.</span></span><span class="sig-name descname"><span class="pre">create_custom_prior_for</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">model</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">par</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">transform</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">aftertransform=&lt;function</span> <span class="pre">&lt;lambda&gt;&gt;</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/priors.html#create_custom_prior_for"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.create_custom_prior_for" title="Permalink to this definition">¶</a></dt>
<dd><p>Pass your own prior weighting transformation</p>
</dd></dl>

</section>
<section id="prior-predictive-checks">
<h2>Prior Predictive Checks<a class="headerlink" href="#prior-predictive-checks" title="Permalink to this heading">¶</a></h2>
<p>To check that your priors and model is okay and working,
create a flipbook of prior sample predictions.</p>
<ol class="arabic">
<li><p>Pick a random sample from the prior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">from</span> <span class="nn">bxa.xspec.solver</span> <span class="kn">import</span> <span class="n">set_parameters</span>

<span class="n">prior_function</span> <span class="o">=</span> <span class="n">bxa</span><span class="o">.</span><span class="n">create_prior_function</span><span class="p">(</span><span class="n">transformations</span><span class="p">)</span>
<span class="n">values</span> <span class="o">=</span> <span class="n">prior_function</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">transformations</span><span class="p">)))</span>
<span class="n">set_parameters</span><span class="p">(</span><span class="n">transformations</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;set to parameters:&quot;</span><span class="p">,</span> <span class="n">values</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>make a plot</p></li>
</ol>
<p>Repeat this 20 times and look at the plots.</p>
<p>Do the shapes and number of counts expected
look like a reasonable representation of your prior expectation?</p>
</section>
<section id="running-the-analysis">
<span id="xspec-run"></span><h2>Running the analysis<a class="headerlink" href="#running-the-analysis" title="Permalink to this heading">¶</a></h2>
<p>This runs the fit and stores the result in the specified output folder:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">outputfiles_basename</span> <span class="o">=</span> <span class="s1">&#39;simplest/&#39;</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">bxa</span><span class="o">.</span><span class="n">BXASolver</span><span class="p">(</span><span class="n">transformations</span><span class="o">=</span><span class="n">transformations</span><span class="p">,</span> <span class="n">outputfiles_basename</span><span class="o">=</span><span class="n">outputfiles_basename</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py class">
<dt class="sig sig-object py">
<em class="property"><span class="pre">class</span><span class="w"> </span></em><span class="sig-prename descclassname"><span class="pre">bxa.xspec.</span></span><span class="sig-name descname"><span class="pre">BXASolver</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">transformations</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">prior_function</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">outputfiles_basename</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'chains/'</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">resume_from</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/solver.html#BXASolver"><span class="viewcode-link"><span class="pre">[source]</span></span></a></dt>
<dd><p>Run the Bayesian analysis.</p>
<p>The nested sampling package <a class="reference external" href="https://johannesbuchner.github.io/UltraNest/">UltraNest</a> is used under the hood.</p>
<p>If prior is None, uniform priors are used on the passed parameters.
If parameters is also None, all thawed parameters are used.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>transformations</strong> – List of parameter transformation definitions</p></li>
<li><p><strong>prior_function</strong> – set only if you want to specify a custom, non-separable prior</p></li>
<li><p><strong>outputfiles_basename</strong> – prefix for output filenames.</p></li>
<li><p><strong>resume_from</strong> – prefix for output filenames of a previous run with similar posterior from which to resume</p></li>
</ul>
</dd>
</dl>
<p>More information on the concept of prior transformations is available at
<a class="reference external" href="https://johannesbuchner.github.io/UltraNest/priors.html">https://johannesbuchner.github.io/UltraNest/priors.html</a></p>
</dd></dl>

<p>The returned results contain posterior samples and the Bayesian evidence.
These are also reported on the screen for you.</p>
</section>
<section id="parameter-posterior-plots">
<span id="xspec-analyse"></span><h2>Parameter posterior plots<a class="headerlink" href="#parameter-posterior-plots" title="Permalink to this heading">¶</a></h2>
<p>Credible intervals of the model parameters, and histograms
(1d and 2d) of the marginal parameter distributions are plotted
in ‘myoutputs/plots/corner.pdf’ for you.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/absorbed-corner.png"><img alt="_images/absorbed-corner.png" src="_images/absorbed-corner.png" style="width: 357.5px; height: 368.5px;" /></a>
</figure>
<p>You can also plot them yourself using corner, triangle and getdist, by
passing <cite>results[‘samples’]</cite> to them.</p>
<p>For more information on the corner library used here,
see <a class="reference external" href="https://corner.readthedocs.io/en/latest/">https://corner.readthedocs.io/en/latest/</a>.</p>
</section>
<section id="model-checking">
<h2>Model checking<a class="headerlink" href="#model-checking" title="Permalink to this heading">¶</a></h2>
<p>For this functionality, you also need scipy installed.</p>
<p>The following code creates a plot of the convolved posterior model:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">data</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">posterior_predictions_convolved</span><span class="p">(</span><span class="n">nsamples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;binning for plot...&#39;</span><span class="p">)</span>
<span class="n">binned</span> <span class="o">=</span> <span class="n">bxa</span><span class="o">.</span><span class="n">binning</span><span class="p">(</span><span class="n">outputfiles_basename</span><span class="o">=</span><span class="n">outputfiles_basename</span><span class="p">,</span> 
	<span class="n">bins</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;bins&#39;</span><span class="p">],</span> <span class="n">widths</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;width&#39;</span><span class="p">],</span> 
	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">models</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;marked_binned&#39;</span><span class="p">]:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">point</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">binned</span><span class="p">[</span><span class="s1">&#39;xlim&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">binned</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Plot</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">==</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">Plot</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">==</span> <span class="s1">&#39;channel&#39;</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Counts/s/cm$^2$&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saving plot...&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outputfiles_basename</span> <span class="o">+</span> <span class="s1">&#39;convolved_posterior.pdf&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id1">
<img alt="_images/absorbed-convolved_posterior.png" src="_images/absorbed-convolved_posterior.png" />
<figcaption>
<p><span class="caption-text">Example of the convolved spectrum with data.
For each posterior sample (solution), the parameters are taken and put
through the model. All such lines are plotted. Where the region is darker,
more lines ended up, and thus it is more likely.
The band covers the 1 sigma equivalent model prediction interval (68 per cent),
the more transparent band contains 99 per cent of the posterior probability.</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
<div class="legend">
<p>The data points are adaptively binned to contain at least 20 counts.
The error bars are created by asking: which model count rate can produce
this amount of counts.
In a Poisson process, the inverse incomplete gamma function provides
this answer. The error bars show the 10%-90% probability range.</p>
<p>On the colors of the data points:</p>
<p>For all intents and purposes, you can ignore the colors.</p>
<p>The colors are intended to aid the discovery of discrepancies, by using
a custom Goodness of Fit measure. In this procedure (gof module),
a tree of the bins is built, i.e. in the first layer, every 2 bins
are merged, in the second, every 4 bins are merged, etc.
Then, the counts in the bins are compared against with
the poisson process of the model. The worst case, i.e. the least likely
probability over the whole tree is considered. That is, for each bin,
the lowest probability of all its merges is kept. Finally, this is multiplied
by the number of nodes in the tree (as more comparisons lead to more
random chances).</p>
<p>Then, if the probability for the bin is below <span class="math notranslate nohighlight">\(10^{-2}\)</span>, the point is marked orange,
and if it reaches below <span class="math notranslate nohighlight">\(10^{-6}\)</span>, it is marked red.</p>
<p>It is ok to ignore the colors, this computation is not used otherwise.</p>
</div>
</figcaption>
</figure>
<p>The following code creates a plot of the unconvolved posterior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">solver</span><span class="o">.</span><span class="n">posterior_predictions_unconvolved</span><span class="p">(</span><span class="n">nsamples</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
<span class="n">ylim</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">()</span>
<span class="c1"># 3 orders of magnitude at most</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">ylim</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mi">1000</span><span class="p">),</span> <span class="n">ylim</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Plot</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">==</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>
<span class="k">elif</span> <span class="n">Plot</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">==</span> <span class="s1">&#39;channel&#39;</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Channel&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Energy flux density [erg/s/cm$^2$/keV]&#39;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s1">&#39;saving plot...&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">outputfiles_basename</span> <span class="o">+</span> <span class="s1">&#39;unconvolved_posterior.pdf&#39;</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<figure class="align-default" id="id2">
<img alt="_images/absorbed-unconvolved_posterior.png" src="_images/absorbed-unconvolved_posterior.png" />
<figcaption>
<p><span class="caption-text">Example of the unconvolved spectrum.
For each posterior sample (solution), the parameters are taken and put
through the model. All such lines are plotted. Where the region is darker,
more lines ended up, and thus it is more likely.</span><a class="headerlink" href="#id2" title="Permalink to this image">¶</a></p>
</figcaption>
</figure>
<p>For plotting the model parameters found against the data, use these functions:</p>
<dl class="py method">
<dt class="sig sig-object py" id="bxa.xspec.BXASolver.posterior_predictions_unconvolved">
<span class="sig-prename descclassname"><span class="pre">BXASolver.</span></span><span class="sig-name descname"><span class="pre">posterior_predictions_unconvolved</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">component_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_args</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nsamples</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">400</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plottype</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">'model'</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/solver.html#BXASolver.posterior_predictions_unconvolved"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.BXASolver.posterior_predictions_unconvolved" title="Permalink to this definition">¶</a></dt>
<dd><p>Plot unconvolved model posterior predictions.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>component_names</strong> – labels to use. Set to ‘ignore’ to skip plotting a component</p></li>
<li><p><strong>plot_args</strong> – list of matplotlib.pyplot.plot arguments for each component, e.g. [dict(color=’r’), dict(color=’g’), dict(color=’b’)]</p></li>
<li><p><strong>nsamples</strong> – number of posterior samples to use (lower is faster)</p></li>
<li><p><strong>plottype</strong> – type of plot string, passed to <cite>xspec.Plot()</cite></p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py" id="bxa.xspec.BXASolver.posterior_predictions_convolved">
<span class="sig-prename descclassname"><span class="pre">BXASolver.</span></span><span class="sig-name descname"><span class="pre">posterior_predictions_convolved</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">component_names</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">plot_args</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">None</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nsamples</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">400</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/solver.html#BXASolver.posterior_predictions_convolved"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.BXASolver.posterior_predictions_convolved" title="Permalink to this definition">¶</a></dt>
<dd><p>Plot convolved model posterior predictions.</p>
<p>Also returns data points for plotting.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>component_names</strong> – labels to use. Set to ‘ignore’ to skip plotting a component</p></li>
<li><p><strong>plot_args</strong> – matplotlib.pyplot.plot arguments for each component</p></li>
<li><p><strong>nsamples</strong> – number of posterior samples to use (lower is faster)</p></li>
</ul>
</dd>
</dl>
</dd></dl>

<dl class="py method">
<dt class="sig sig-object py">
<span class="sig-prename descclassname"><span class="pre">sinning.</span></span><span class="sig-name descname"><span class="pre">binning</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">bins</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">widths</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">data</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">models</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">nmin</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">20</span></span></em><span class="sig-paren">)</span></dt>
<dd><p>Bins the data for plotting and checks the model.</p>
<p>Using the gof module, computes a Poisson goodness-of-fit range,
i.e. ranges where the model must lie. This is done for multiple
binning sizes simultaneously.</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>outputfiles_basename</strong> – not used.</p></li>
<li><p><strong>bins</strong> – bin location from Plot.x()</p></li>
<li><p><strong>widths</strong> – bin width from Plot.xErr()</p></li>
<li><p><strong>data</strong> – counts per bin width from Plot.y() with Plot.background = True and Plot(‘counts’)</p></li>
<li><p><strong>model</strong> – counts per bin width predicted by the model, from Plot.model()</p></li>
<li><p><strong>nmin</strong> – number of counts per bin to use for rebinning.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p><ul class="simple">
<li><p><strong>* marked_binned</strong> (data points binned to contain <cite>nmin</cite> counts) – a sequence ready to be passed to matplotlib.pyplot.errorbar</p></li>
<li><p><strong>* modelrange</strong> (<em>range allowed by the data</em>) – ready to be passed to matplotlib.pyplot.fill_between</p></li>
<li><p><em>* and statistics (GoF measure)</em></p></li>
</ul>
</p>
</dd>
</dl>
</dd></dl>

</section>
<section id="error-propagation">
<h2>Error propagation<a class="headerlink" href="#error-propagation" title="Permalink to this heading">¶</a></h2>
<p><cite>results[‘samples’]</cite> provides access to the posterior samples (similar to a Markov Chain).
Use these to propagate errors:</p>
<ul class="simple">
<li><p>For every row in the chain, compute the quantity of interest</p></li>
<li><p>Then, make a histogram of the results, or compute mean and standard deviations.</p></li>
</ul>
<p>This preserves the structure of the uncertainty (multiple modes, degeneracies, etc.)</p>
<p><em>Continuing in Xspec</em>: A chain file, compatible with Xspec chain commands is
written for you into <em>&lt;outputfiles_basename&gt;chain.fits</em>. In Xspec, load it using <a class="reference external" href="https://heasarc.gsfc.nasa.gov/xanadu/xspec/manual/XSchain.html">“chain load”</a>.
This should set parameters, and compute flux estimates.</p>
</section>
<section id="model-comparison">
<span id="xspec-models"></span><h2>Model comparison<a class="headerlink" href="#model-comparison" title="Permalink to this heading">¶</a></h2>
<p><em>examples/xspec/model_compare.py</em> shows an example of model selection. Keep in mind what model prior you would like to use.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Case 1: Multiple models, want to find one best one to use from there on:</dt><dd><ul>
<li><p>follow <em>examples/model_compare.py</em>, and pick the model with the highest evidence</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 2: Simpler and more complex models, want to find out which complexity is justified:</dt><dd><ul>
<li><p>follow <em>examples/model_compare.py</em>, and keep the models above a certain threshold</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 3: Multiple models which could be correct, only interested in a parameter</dt><dd><ul>
<li><p>Marginalize over the models: Use the posterior samples from each model, and weigh them by the
relative probability of the models (weight = exp(lnZ))</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Example output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jbuchner@ds42 $ python model_compare.py absorbed/ line/ simplest/

Model comparison
****************

model simplest : log10(Z) = -1632.7  XXX ruled out
model absorbed : log10(Z) =    -7.5  XXX ruled out
model line     : log10(Z) =     0.0    &lt;-- GOOD

The last, most likely model was used as normalization.
Uniform model priors are assumed, with a cut of log10(30) to rule out models.

jbuchner@ds42 $
</pre></div>
</div>
<p>Here, the probability of the second-best model, “absorbed”, is <span class="math notranslate nohighlight">\(10^7.5\)</span> times
less likely than the model “line”. As this exceeds our threshold (by a lot!)
we can claim the detection of an iron line!</p>
<p>Monte Carlo simulated spectra are recommended to derive a
Bayes factor threshold for a preferred false selection rate.
You can find an example in the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2014A%26A...564A.125B/abstract">Appendix of Buchner+14</a>
and in <a class="reference external" href="https://johannesbuchner.github.io/UltraNest/example-sine-modelcomparison.html">the ultranest tutorial</a>.</p>
</section>
<section id="experiment-design">
<span id="xspec-design"></span><h2>Experiment design<a class="headerlink" href="#experiment-design" title="Permalink to this heading">¶</a></h2>
<p>We want to to evaluate whether a planned experiment can detect features or constrain parameters,
i.e. determine the discriminatory power of future configurations/surveys/missions.</p>
<p>For this, simulate a few spectra using the appropriate response.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Case 1: Can the experiment constrain the parameters?</dt><dd><ul>
<li><p>Analyse and check what fraction of the posterior samples lie inside/outside the region of interest.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 2: Can the experiment distinguish between two models?</dt><dd><ul>
<li><p>Model selection as above.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 3: Which sources (redshift range, luminosity, etc) can be distinguished?</dt><dd><ul>
<li><p>Compute a grid of spectra. Do model selection at each point in the grid.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="model-discovery">
<span id="xspec-qq"></span><h2>Model discovery<a class="headerlink" href="#model-discovery" title="Permalink to this heading">¶</a></h2>
<p>Is the model the right one? Is there more in the data? These questions can not
be answered in a statistical way, <strong>but</strong> what we can do is</p>
<ol class="arabic simple">
<li><p>generate ideas on what models could fit better</p></li>
<li><p>test those models for significance with model selection</p></li>
</ol>
<p>For the first point, <strong>Quantile-Quantile plots</strong> provide a unbinned, less noisy alternative to
residual plots.</p>
<img alt="_images/absorbed-qq_model_deviations.png" src="_images/absorbed-qq_model_deviations.png" />
<img alt="_images/absorbed-convolved_posterior.png" src="_images/absorbed-convolved_posterior.png" />
<p>QQ plot example (left), with the corresponding spectrum for comparison (right).</p>
<p>In these plots, for each energy the number of counts observed with lower energy
are plotted on one axis, while the predicted are on the other axis.
If model and data agree perfectly, this would be a straight line.
Deviances are indications of possible mis-fits.</p>
<p>This example is almost a perfect fit!
You can see a offset growing at 6-7 keV, which remains at higher energies.
This indicates that the data has more counts than the model there.</p>
<p>As the growth is in a S-shape, it is probably a Gaussian (see its <a class="reference external" href="https://en.wikipedia.org/wiki/Normal_distribution">cumulative density function</a>).</p>
<p>Refer to the appendix of the <a class="reference external" href="cite">accompaning paper</a> for more examples.</p>
<p>For Xspec, the <em>qq</em> function in the <em>qq</em> module allows you to create such plots easily:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>	<span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;data&#39;</span><span class="p">],</span> <span class="n">models</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;models&#39;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">point</span> <span class="ow">in</span> <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;marked_binned&#39;</span><span class="p">]:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">,</span> <span class="n">zorder</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="o">**</span><span class="n">point</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlim</span><span class="p">(</span><span class="n">binned</span><span class="p">[</span><span class="s1">&#39;xlim&#39;</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylim</span><span class="p">(</span><span class="n">binned</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">binned</span><span class="p">[</span><span class="s1">&#39;ylim&#39;</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="mi">2</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
<span class="k">if</span> <span class="n">Plot</span><span class="o">.</span><span class="n">xAxis</span> <span class="o">==</span> <span class="s1">&#39;keV&#39;</span><span class="p">:</span>
	<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Energy [keV]&#39;</span><span class="p">)</span>
</pre></div>
</div>
<dl class="py function">
<dt class="sig sig-object py" id="bxa.xspec.qq.qq">
<span class="sig-prename descclassname"><span class="pre">bxa.xspec.qq.</span></span><span class="sig-name descname"><span class="pre">qq</span></span><span class="sig-paren">(</span><em class="sig-param"><span class="n"><span class="pre">prefix</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">markers</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">5</span></span></em>, <em class="sig-param"><span class="n"><span class="pre">annotate</span></span><span class="o"><span class="pre">=</span></span><span class="default_value"><span class="pre">True</span></span></em><span class="sig-paren">)</span><a class="reference internal" href="_modules/bxa/xspec/qq.html#qq"><span class="viewcode-link"><span class="pre">[source]</span></span></a><a class="headerlink" href="#bxa.xspec.qq.qq" title="Permalink to this definition">¶</a></dt>
<dd><p>Create a quantile-quantile plot for model discovery (deviations in data from model).</p>
<p>The current data and model is used, so call <em>set_best_fit(analyzer, transformations)</em>
before, to get the qq plot at the best fit.</p>
<ul class="simple">
<li><p>markers: list of energies/channels (whichever the current plotting xaxis unit)
or number of equally spaced markers between minimum+maximum.</p></li>
<li><p>annotate: add information to the plot</p></li>
</ul>
</dd></dl>

<p>Refer to the <a class="reference internal" href="index.html#cite"><span class="std std-ref">accompaning paper</span></a>, which gives an introduction and
detailed discussion on the methodology.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">BXA (Bayesian X-ray Analysis)</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="sherpa-analysis.html">Sherpa with BXA</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Xspec with BXA</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Learn more</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="visualisations.html">Visualisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="engine.html">Inference engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="convenience.html">Convenience features</a></li>
<li class="toctree-l1"><a class="reference internal" href="background-models.html">Empirical background models</a></li>
<li class="toctree-l1"><a class="reference internal" href="pca-background-models.html">PCA-based background models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Example scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="xagnfitter.html">Obscured Active Galactic Nuclei</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="sherpa-analysis.html" title="previous chapter">Sherpa with BXA</a></li>
      <li>Next: <a href="contributing.html" title="next chapter">Contributing</a></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2013-2022, Johannes Buchner.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 5.1.1</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
      |
      <a href="_sources/xspec-analysis.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>