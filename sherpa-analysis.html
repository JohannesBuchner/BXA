<!DOCTYPE html>

<html lang="en" data-content_root="./">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Sherpa with BXA &#8212; BXA (Bayesian X-ray Analysis) 5.1.2 documentation</title>
    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/alabaster.css?v=12dfc556" />
    <script src="_static/documentation_options.js?v=2c218288"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Xspec with BXA" href="xspec-analysis.html" />
    <link rel="prev" title="Welcome to BXA’s documentation!" href="index.html" />
   
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />
  

  
  
    <link rel="canonical" href="https://johannesbuchner.github.io/BXA/sherpa-analysis.html" />
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <section id="sherpa-with-bxa">
<h1>Sherpa with BXA<a class="headerlink" href="#sherpa-with-bxa" title="Link to this heading">¶</a></h1>
<p>Begin by loading bxa in a session with sherpa loaded:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">bxa.sherpa</span> <span class="k">as</span> <span class="nn">bxa</span>
</pre></div>
</div>
<section id="defining-priors">
<span id="sherpa-priors"></span><h2>Defining priors<a class="headerlink" href="#defining-priors" title="Link to this heading">¶</a></h2>
<p>Define your background model and source model as usual in sherpa.
Then define the priors over the free parameters, for example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># three parameters we want to vary</span>
<span class="n">param1</span> <span class="o">=</span> <span class="n">xsapec</span><span class="o">.</span><span class="n">myapec</span><span class="o">.</span><span class="n">norm</span>
<span class="n">param2</span> <span class="o">=</span> <span class="n">xspowerlaw</span><span class="o">.</span><span class="n">mypowerlaw</span><span class="o">.</span><span class="n">norm</span>
<span class="n">param3</span> <span class="o">=</span> <span class="n">xspowerlaw</span><span class="o">.</span><span class="n">mypowerlaw</span><span class="o">.</span><span class="n">PhoIndex</span>

<span class="c1"># list of parameters</span>
<span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="n">param1</span><span class="p">,</span> <span class="n">param2</span><span class="p">,</span> <span class="n">param3</span><span class="p">]</span>
<span class="c1"># list of prior transforms</span>
<span class="n">priors</span> <span class="o">=</span> <span class="p">[</span>
   <span class="n">bxa</span><span class="o">.</span><span class="n">create_uniform_prior_for</span><span class="p">(</span><span class="n">param1</span><span class="p">),</span>
   <span class="n">bxa</span><span class="o">.</span><span class="n">create_loguniform_prior_for</span><span class="p">(</span><span class="n">param2</span><span class="p">),</span>
   <span class="n">bxa</span><span class="o">.</span><span class="n">create_gaussian_prior_for</span><span class="p">(</span><span class="n">param3</span><span class="p">,</span> <span class="mf">1.95</span><span class="p">,</span> <span class="mf">0.15</span><span class="p">),</span>
   <span class="c1"># and more priors</span>
<span class="p">]</span>

<span class="c1"># make a single function:</span>
<span class="n">priorfunction</span> <span class="o">=</span> <span class="n">bxa</span><span class="o">.</span><span class="n">create_prior_function</span><span class="p">(</span><span class="n">priors</span><span class="p">)</span>
</pre></div>
</div>
<p>Make sure you set the parameter minimum and maximum values to appropriate (a priori reasonable) values.
The limits are used to define the uniform and loguniform priors.</p>
<p>You can freeze the parameters you do not want to investigate, but BXA only modifies the parameters specified.
As a hint, you can find all thawed parameters of a model with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">parameters</span> <span class="o">=</span> <span class="p">[</span><span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">get_model</span><span class="p">()</span><span class="o">.</span><span class="n">pars</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">p</span><span class="o">.</span><span class="n">frozen</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">link</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">]</span>
</pre></div>
</div>
<p>You can also define your own prior functions, which transform
unit variables unto the values needed for each parameter.
See the <a class="reference external" href="https://johannesbuchner.github.io/UltraNest/priors.html">UltraNest documentation on priors</a>
for more details about this concept.
The script <a class="reference external" href="https://github.com/JohannesBuchner/BXA/blob/master/examples/sherpa/example_automatic_background_model.py">examples/sherpa/example_automatic_background_model.py</a>
gives an example of such a custom prior function (<cite>limited_19_24</cite>).</p>
<p>API information:</p>
</section>
<section id="prior-predictive-checks">
<span id="sherpa-prior-predictive-checks"></span><h2>Prior Predictive Checks<a class="headerlink" href="#prior-predictive-checks" title="Link to this heading">¶</a></h2>
<p>To check that your priors and model is okay and working,
create a flipbook of prior samples.</p>
<ol class="arabic">
<li><p>Pick a random sample from the prior:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">parameter</span><span class="p">,</span> <span class="n">prior_function</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">priors</span><span class="p">):</span>
         <span class="n">parameter</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">prior_function</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">())</span>
</pre></div>
</div>
</li>
<li><p>make a plot (plot_model, plot_source, etc.)</p></li>
</ol>
<p>Repeat this 20 times and look at the plots.</p>
<p>Do the shapes and number of counts expected
look like a reasonable representation of your prior expectation?</p>
</section>
<section id="running-the-analysis">
<span id="sherpa-run"></span><h2>Running the analysis<a class="headerlink" href="#running-the-analysis" title="Link to this heading">¶</a></h2>
<p>You need to specify a prefix, called <em>outputfiles_basename</em> where the files are stored.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># see the pymultinest documentation for all options</span>
<span class="n">solver</span> <span class="o">=</span> <span class="n">bxa</span><span class="o">.</span><span class="n">BXASolver</span><span class="p">(</span><span class="n">prior</span><span class="o">=</span><span class="n">priorfunction</span><span class="p">,</span> <span class="n">parameters</span><span class="o">=</span><span class="n">parameters</span><span class="p">,</span>
             <span class="n">outputfiles_basename</span> <span class="o">=</span> <span class="s2">&quot;myoutputs/&quot;</span><span class="p">)</span>
<span class="n">results</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">resume</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>API information:</p>
</section>
<section id="parameter-posterior-plots">
<span id="sherpa-analyse"></span><h2>Parameter posterior plots<a class="headerlink" href="#parameter-posterior-plots" title="Link to this heading">¶</a></h2>
<p>Credible intervals of the model parameters, and histograms
(1d and 2d) of the marginal parameter distributions are plotted
in ‘myoutputs/plots/corner.pdf’ for you.</p>
<figure class="align-default">
<a class="reference internal image-reference" href="_images/absorbed-corner.png"><img alt="_images/absorbed-corner.png" src="_images/absorbed-corner.png" style="width: 356.5px; height: 368.5px;" /></a>
</figure>
<p>You can also plot them yourself using corner, triangle and getdist, by
passing <cite>results[‘samples’]</cite> to them.</p>
<p>For more information on the corner library used here,
see <a class="reference external" href="https://corner.readthedocs.io/en/latest/">https://corner.readthedocs.io/en/latest/</a>.</p>
</section>
<section id="error-propagation">
<h2>Error propagation<a class="headerlink" href="#error-propagation" title="Link to this heading">¶</a></h2>
<p><cite>results[‘samples’]</cite> provides access to the posterior samples (similar to a Markov Chain).
Use these to propagate errors:</p>
<ul class="simple">
<li><p>For every row in the chain, compute the quantity of interest</p></li>
<li><p>Then, make a histogram of the results, or compute mean and standard deviations.</p></li>
</ul>
<p>This preserves the structure of the uncertainty (multiple modes, degeneracies, etc.)</p>
<p>BXA also allows you to compute the fluxes corresponding to the
parameter estimation, giving the correct probability distribution on the flux.
With distance information (fixed value or distribution), you can later infer
the correct luminosity distribution.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dist</span> <span class="o">=</span> <span class="n">solver</span><span class="o">.</span><span class="n">get_distribution_with_fluxes</span><span class="p">(</span><span class="n">lo</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
<span class="n">numpy</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">out</span> <span class="o">+</span> <span class="n">prefix</span> <span class="o">+</span> <span class="s2">&quot;dist.txt&quot;</span><span class="p">,</span> <span class="n">dist</span><span class="p">)</span>
</pre></div>
</div>
<p>API information:</p>
<p>This does nothing more than:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">r</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">results</span><span class="p">[</span><span class="s1">&#39;samples&#39;</span><span class="p">]:</span>
        <span class="c1"># set the parameter values to the current sample</span>
        <span class="k">for</span> <span class="n">p</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">parameters</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">val</span> <span class="o">=</span> <span class="n">v</span>
        <span class="n">r</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="o">+</span> <span class="p">[</span><span class="n">calc_photon_flux</span><span class="p">(</span><span class="n">lo</span><span class="o">=</span><span class="n">elo</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">ehi</span><span class="p">),</span>
                <span class="n">calc_energy_flux</span><span class="p">(</span><span class="n">lo</span><span class="o">=</span><span class="n">elo</span><span class="p">,</span> <span class="n">hi</span><span class="o">=</span><span class="n">ehi</span><span class="p">)])</span>
</pre></div>
</div>
<p>Such loops can be useful for computing obscuration-corrected, rest-frame luminosities,
(modifying the nH parameter and the energy ranges before computing the fluxes).</p>
</section>
<section id="model-comparison">
<span id="sherpa-models"></span><h2>Model comparison<a class="headerlink" href="#model-comparison" title="Link to this heading">¶</a></h2>
<p><em>examples/xspec/model_compare.py</em> shows an example of model selection. Keep in mind what model prior you would like to use.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Case 1: Multiple models, want to find one best one to use from there on:</dt><dd><ul>
<li><p>follow <em>examples/model_compare.py</em>, and pick the model with the highest evidence</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 2: Simpler and more complex models, want to find out which complexity is justified:</dt><dd><ul>
<li><p>follow <em>examples/model_compare.py</em>, and keep the models above a certain threshold</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 3: Multiple models which could be correct, only interested in a parameter</dt><dd><ul>
<li><p>Marginalize over the models: Use the posterior samples from each model, and weigh them by the
relative probability of the models (weight = exp(lnZ))</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
<p>Example output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>jbuchner@ds42 $ python model_compare.py absorbed/ line/ simplest/

Model comparison
****************

model simplest : log10(Z) = -1632.7  XXX ruled out
model absorbed : log10(Z) =    -7.5  XXX ruled out
model line     : log10(Z) =     0.0    &lt;-- GOOD

The last, most likely model was used as normalization.
Uniform model priors are assumed, with a cut of log10(30) to rule out models.

jbuchner@ds42 $
</pre></div>
</div>
<p>Here, the probability of the second-best model, “absorbed”, is <span class="math notranslate nohighlight">\(10^7.5\)</span> times
less likely than the model “line”. As this exceeds our threshold (by a lot!)
we can claim the detection of an iron line!</p>
<p>Monte Carlo simulated spectra are recommended to derive a
Bayes factor threshold for a preferred false selection rate.
You can find an example in the <a class="reference external" href="https://ui.adsabs.harvard.edu/abs/2014A%26A...564A.125B/abstract">Appendix of Buchner+14</a>
and in <a class="reference external" href="https://johannesbuchner.github.io/UltraNest/example-sine-modelcomparison.html">the ultranest tutorial</a>.</p>
</section>
<section id="experiment-design">
<span id="sherpa-design"></span><h2>Experiment design<a class="headerlink" href="#experiment-design" title="Link to this heading">¶</a></h2>
<p>We want to to evaluate whether a planned experiment can detect features or constrain parameters,
i.e. determine the discriminatory power of future configurations/surveys/missions.</p>
<p>For this, simulate a few spectra using the appropriate response.</p>
<ul class="simple">
<li><dl class="simple">
<dt>Case 1: Can the experiment constrain the parameters?</dt><dd><ul>
<li><p>Analyse and check what fraction of the posterior samples lie inside/outside the region of interest.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 2: Can the experiment distinguish between two models?</dt><dd><ul>
<li><p>Model selection as above.</p></li>
</ul>
</dd>
</dl>
</li>
<li><dl class="simple">
<dt>Case 3: Which sources (redshift range, luminosity, etc) can be distinguished?</dt><dd><ul>
<li><p>Compute a grid of spectra. Do model selection at each point in the grid.</p></li>
</ul>
</dd>
</dl>
</li>
</ul>
</section>
<section id="model-discovery">
<span id="sherpa-qq"></span><h2>Model discovery<a class="headerlink" href="#model-discovery" title="Link to this heading">¶</a></h2>
<p>Is the model the right one? Is there more in the data? These questions can not
be answered in a statistical way, <strong>but</strong> what we can do is</p>
<ol class="arabic simple">
<li><p>generate ideas on what models could fit better</p></li>
<li><p>test those models for significance with model selection</p></li>
</ol>
<p>For the first point, <strong>Quantile-Quantile plots</strong> provide a unbinned, less noisy alternative to
residual plots.</p>
<img alt="_images/absorbed-qq_model_deviations.png" src="_images/absorbed-qq_model_deviations.png" />
<img alt="_images/absorbed-convolved_posterior.png" src="_images/absorbed-convolved_posterior.png" />
<p>QQ plot example (left), with the corresponding spectrum for comparison (right).</p>
<p>In these plots, for each energy the number of counts observed with lower energy
are plotted on one axis, while the predicted are on the other axis.
If model and data agree perfectly, this would be a straight line.
Deviances are indications of possible mis-fits.</p>
<p>This example is almost a perfect fit!
You can see a offset growing at 6-7 keV, which remains at higher energies.
This indicates that the data has more counts than the model there.</p>
<p>As the growth is in a S-shape, it is probably a Gaussian (see its <a class="reference external" href="https://en.wikipedia.org/wiki/Normal_distribution">cumulative density function</a>).</p>
<p>Refer to the appendix of the <a class="reference external" href="cite">accompaning paper</a> for more examples.</p>
<p>The <em>qq</em> function in the <em>qq</em> module allows you to create such plots easily, by
exporting the cumulative functions into a file.</p>
<p>Refer to the <a class="reference internal" href="index.html#cite"><span class="std std-ref">accompaning paper</span></a>, which gives an introduction and
detailed discussion on the methodology.</p>
</section>
</section>


          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="index.html">BXA (Bayesian X-ray Analysis)</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Documentation</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Sherpa with BXA</a></li>
<li class="toctree-l1"><a class="reference internal" href="xspec-analysis.html">Xspec with BXA</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="history.html">Release Notes</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Learn more</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="visualisations.html">Visualisations</a></li>
<li class="toctree-l1"><a class="reference internal" href="engine.html">Inference engine</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="convenience.html">Convenience features</a></li>
<li class="toctree-l1"><a class="reference internal" href="background-models.html">Empirical background models</a></li>
<li class="toctree-l1"><a class="reference internal" href="pca-background-models.html">PCA-based background models</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Examples</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="examples.html">Example scripts</a></li>
<li class="toctree-l1"><a class="reference internal" href="xagnfitter.html">Obscured Active Galactic Nuclei</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_usage_plotbxa.html">PlotBXA example</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorial_usage_plotxspec.html">PlotXspec example</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="index.html">Documentation overview</a><ul>
      <li>Previous: <a href="index.html" title="previous chapter">Welcome to BXA’s documentation!</a></li>
      <li>Next: <a href="xspec-analysis.html" title="next chapter">Xspec with BXA</a></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2013-2025, Johannes Buchner.
      
      |
      <a href="_sources/sherpa-analysis.rst.txt"
          rel="nofollow">Page source</a>
    </div>

    

    
  </body>
</html>